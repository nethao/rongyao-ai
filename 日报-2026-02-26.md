# 荣耀AI审核发布系统 - 开发与修改记录 2026-02-26

## 一、OTHER_URL 来源图标与展示

### 1.1 需求
- 识别为 **OTHER_URL（其他链接）** 的来源在界面用 **web.svg** 图标展示，不再显示「未知」或 text 图标。
- 涉及：审核详情页头部标签、投稿列表页来源列。

### 1.2 修改内容
| 文件 | 修改说明 |
|------|----------|
| `frontend/public/icons/web.svg` | 新增图标文件（从项目根目录 web.svg 复制） |
| `frontend/src/views/AuditView.vue` | 头部 `el-tag`：当 `content_source === 'other_url'` 时用 `<img :src="webIconUrl">` 显示 web.svg；`getSourceLabel` / `getSourceTagType` 增加 `other_url: '其他链接'` / `other_url: 'info'`；增加 `normalizeContentSource`、`isOtherUrlSource` 兼容大小写/连字符 |
| `frontend/src/views/SubmissionsView.vue` | 列表来源列：`other_url` 使用 `webIconUrl`（web.svg）；增加 `normalizeContentSource`，来源判断统一用规范化后的值 |

### 1.3 图标路径
- 使用 `import.meta.env.BASE_URL + 'icons/web.svg'`（`webIconUrl`），保证部署子路径时也能正确加载。

---

## 二、前端访问与运行环境

### 2.1 配置修改
| 文件 | 修改说明 |
|------|----------|
| `frontend/vite.config.js` | `server.host: true`，便于 e.com 等域名访问；`server.proxy['/api'].target` 改为 `process.env.VITE_API_PROXY_TARGET || 'http://localhost:8000'`（本地开发不再依赖 `backend:8000`）；`cacheDir: '.vite-cache'` 避免 `node_modules/.vite` 权限问题 |

### 2.2 现象与结论
- 列表空表：多为 **未登录 403** 或代理之前指向 `backend:8000` 导致 500，非数据为空。
- 测试地址：`http://localhost:3001/`（Vite 开发）、`http://localhost:3000/`（Docker 前端）、`http://e.com:3000`（需 hosts 配置 e.com → 127.0.0.1）。

---

## 三、Word 邮件处理（ID 32 等）修复

### 3.1 问题
- Word 文档排版错乱（段落被并段）。
- 图片未抓取保存（0 张图、`media_map` 为空）。

### 3.2 修改内容

| 文件 | 修改说明 |
|------|----------|
| `backend/app/services/document_processor.py` | `extract_text_from_docx`：段落之间用 `\n\n` 拼接，避免 Markdown 渲染时并段导致排版错乱 |
| `backend/app/tasks/email_tasks.py` | **WORD 分支**：① 支持邮件中「Word + 独立图片附件」：识别 `.jpg/.jpeg/.png` 等附件，加入 `images_to_upload`，在正文末尾追加 `[[IMG_N]]` 占位符；② 在 WORD 分支内先提取 Word 内嵌图片加入 `images_to_upload`，再统一走后续上传逻辑；③ 删除后面重复的「再按 docx_path 提取并上传 Word 图片」段落，避免重复；④ **Word/ARCHIVE** 创建草稿时显式传入 `original_content_md`、`ai_content_md`、`media_map`（按 `oss_urls_ordered` 生成），避免草稿无图；⑤ 初始化 `image_urls = []`，避免 WORD 分支上传循环中引用未定义变量报错 |

### 3.3 验证
- 重处理「小河镇：乡贤反哺桑梓 路灯点亮乡情」等邮件，新记录（如 ID 44）为 `docx`，图片数 2，`media_map` 正常。

---

## 四、邮件类型识别规则（优先附件）

### 4.1 问题
- 邮件带 **Word 附件** 且正文有链接时，被误判为 **other_url**（如 ID 45 景村、ID 41 收假收心会）。

### 4.2 修改内容
| 文件 | 修改说明 |
|------|----------|
| `backend/app/services/email_parser.py` | `detect_content_type`：**先根据附件判断**，再根据正文链接判断。若附件中存在 `.doc`/`.docx` 则返回 `ContentType.WORD`；存在压缩包/视频则返回对应类型；无附件或附件不匹配时再按正文公众号/美篇/其他链接判断 |

### 4.3 验证
- 重处理「景村：暖心扫雪迎新年 干群同心护平安」「召开收假收心会 凝心聚力启新程」等，新记录均为 `docx`，图片正常。

---

## 五、邮件标题解析（3 段支持）

### 5.1 问题
- 标题仅 3 段（如「投，头，烟霞收费站」）时，解析要求至少 4 段，导致合作方式、媒体、来稿单位均为空，列表显示 `-`。

### 5.2 修改内容
| 文件 | 修改说明 |
|------|----------|
| `backend/app/services/email_parser.py` | `parse_subject`：支持 **3 段** 格式。分割后若 `len(parts) >= 3` 则解析：合作方式=parts[0]、媒体=parts[1]、来稿单位=parts[2]，标题=parts[3]（若存在）否则用整条 subject；仍按逗号/顿号分割，最多 4 段 |

### 5.3 效果
- 新抓取的「投，头，烟霞收费站」类邮件会正确填充合作方式（投稿）、媒体（今日头条）、来稿单位（烟霞收费站）。历史已入库数据不会自动回填。

---

## 六、按关键词重抓邮件

- 为验证修复，按关键词在邮箱中定位并重处理了多封邮件（脚本在容器内执行 `process_email`）：
  - 小河镇：乡贤反哺桑梓 路灯点亮乡情
  - 景村：暖心扫雪迎新年 干群同心护平安
  - 彬州市科技局 召开收假收心会 凝心聚力启新程
  - 烟霞收费站（新记录 ID 49，标题取自 Word：笔墨迎春送祝福 情暖一线聚人心，docx，3 张图）

---

## 七、路由与 ID 说明

- 审核页路由为 **草稿 ID**：`/audit/:draftId`，不是投稿 ID。例如投稿 ID=44 对应草稿 ID=43，应访问 `/audit/43`。

---

## 八、部署与重启约定

- 后端或邮件处理逻辑修改后需 **重启 backend 与 celery_worker** 方能生效。
- 重启命令：`docker-compose restart backend celery_worker`（项目根目录执行）。

---

## 九、涉及文件清单

- **前端**：`frontend/vite.config.js`，`frontend/public/icons/web.svg`，`frontend/src/views/AuditView.vue`，`frontend/src/views/SubmissionsView.vue`
- **后端**：`backend/app/services/email_parser.py`，`backend/app/services/document_processor.py`，`backend/app/tasks/email_tasks.py`

---

*记录日期：2026-02-26*
