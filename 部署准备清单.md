# 部署准备清单

## 主程序数据库（PostgreSQL）

- 后端和 Celery 使用 **PostgreSQL**（db 容器），密码来自 `.env` 的 `POSTGRES_PASSWORD`。
- 若登录 e.com 提示「服务器错误」且后端日志出现 `password authentication failed for user "postgres"`，说明数据卷里的密码与当前 `.env` 不一致。处理方式：
  ```bash
  docker-compose stop backend celery_worker db
  docker volume rm rongyao-ai_postgres_data
  docker-compose up -d db
  # 等待约 10 秒后
  docker-compose up -d backend && docker-compose run --rm -e ADMIN_PASSWORD=你的密码 backend python3 scripts/init_admin.py
  docker-compose up -d celery_worker
  ```

## WordPress 数据库（wp_db）

- 四个站点共用一台 MySQL（wp_db），数据库名为 **wp_a / wp_b / wp_c / wp_d**。
- 首次启动 MySQL 时会自动执行 `docker/mysql/init/02-create-wp-databases.sql` 创建这四个库。
- 若曾改过 `.env` 里的 `WP_MYSQL_ROOT_PASSWORD` 或 `WP_DB_PASSWORD`，而 MySQL 是旧数据卷，会连不上库。处理方式：停掉 wp 与 wp_db 后删卷重建：
  ```bash
  docker-compose stop wp_a wp_b wp_c wp_d wp_db
  docker volume rm rongyao-ai_wp_db_data
  docker-compose up -d wp_db
  # 等待约 20 秒后再启动四个 WP
  docker-compose up -d wp_a wp_b wp_c wp_d
  ```

## 本地通过域名访问（e.com + a/b/c/d.com）

本机需把域名解析到 127.0.0.1，否则浏览器无法用 e.com 等访问。

**Linux / macOS**：编辑 `/etc/hosts`，加入（需 sudo）：

```
127.0.0.1   e.com a.com b.com c.com d.com
```

保存后：
- **主程序（管理后台）**：http://e.com
- **WordPress 站点**：http://a.com 、http://b.com 、http://c.com 、http://d.com

Nginx 已配置为：
- **e.com** → 前端（3000）+ `/api/` → 后端（8000）
- **a.com / b.com / c.com / d.com** → 对应 WordPress 容器

---

## A/B/C/D 四个 WordPress 站点的 API 与密钥

### 1. 在系统中初始化四站点

若数据库里还没有 A/B/C/D 四个站点，可执行（默认 API 用户名为 `admin`，可用环境变量 `WP_API_USERNAME` 覆盖）：

```bash
docker-compose exec backend python3 scripts/init_wp_sites.py
```

会创建：A站 `http://a.com`、B站 `http://b.com`、C站 `http://c.com`、D站 `http://d.com`，并统一设置 API 用户名为 `admin`（或你指定的用户名）。**应用程序密码**需在下面步骤中为每个站点单独配置。

### 2. 在 WordPress 中开启 REST API 与应用程序密码

- WordPress 5.6+ 已默认开启 **REST API**，无需额外设置。
- **应用程序密码**（供本系统调用 WP 接口）：  
  1. 浏览器访问 **http://a.com/wp-admin/**（b.com / c.com / d.com 同理）。  
  2. 使用管理员账号登录。  
  3. 进入 **用户 → 个人资料**，页面底部找到 **「应用程序密码」**。  
  4. 在「新应用程序密码名称」中填写例如 `荣耀AI发布`，点击 **「添加新应用程序密码」**。  
  5. 复制页面上显示的**一次性密码**（格式类似 `xxxx xxxx xxxx xxxx xxxx xxxx`），保存到本机备用（关闭页面后无法再查看）。

### 3. 在 e.com 管理后台填写密钥

- 登录 **http://e.com** → **系统配置**（或 **WordPress 站点** 管理页）。  
- 对 A/B/C/D 每个站点：  
  - **API 用户名**：与 WP 后台登录用户一致（若用上面脚本初始化，一般为 `admin`）。  
  - **应用程序密码**：粘贴上一步复制的密码（可含空格，系统会自动去掉）。  
- 保存后可用下方「批量测试」检查是否连通。

### 4. 测试接口

- **单个站点测试**：`POST /api/wordpress-sites/{site_id}/test`（需登录）。  
- **批量测试四个站点**：`POST /api/wordpress-sites/test-all?active_only=true`（需登录），返回每个站点的 `valid` 与 `message`，便于一次性检查 A/B/C/D 的 API 与密钥是否生效。

## 压缩包依赖（RAR/7Z）
- 生产环境需安装解压依赖：`p7zip-full`、`unrar`（用于处理 `.rar` / `.7z` 附件）。
- Docker 部署：已在 `docker/backend/Dockerfile` 添加依赖，**需重建镜像**后生效。
