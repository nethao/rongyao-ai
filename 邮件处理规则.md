# 邮件处理规则说明

## 📧 邮件标题格式

**格式**：`[合作方式]+[对应媒体]+[来稿单位名称]+[标题]`

**示例**：`投，时，凤翔区人社局，春风迎归人 人社暖民心`

### 合作方式
- `投` - 免费投稿客户
- `合` - 合作客户

### 媒体类型映射

| 标识 | 媒体名称 | WordPress站点 | 站点ID |
|------|----------|---------------|--------|
| 荣 | 荣耀网 | 站点A (a.com) | 7 |
| 时 | 时代网 | 站点B (b.com) | 8 |
| 争/优 | 争先网 | 站点C (c.com) | 9 |
| 政 | 政企网 | 站点D (d.com) | 10 |
| 头 | 今日头条 | 手动发布 | - |

## 📝 邮件内容类型（按来源分类）

### 1. Word文档类
**支持格式**：
- 纯文档附件（.doc / .docx）
- 文档 + 图片附件
- 文档 + 视频附件
- 邮件正文内容 + 图片附件
- 文档 + 图片 + 视频

**处理流程**：
1. 提取文档文本内容（如有附件）
2. 提取邮件正文内容（如无文档附件）
3. 提取文档内嵌图片
4. 收集附件中的图片文件
5. 收集附件中的视频文件
6. 上传图片到OSS
7. 上传视频到OSS（如有）
8. 生成草稿交由AI改写

**示例场景**：
- `report.docx` - 纯文档
- `report.docx + photo1.jpg + photo2.png` - 文档+图片
- `report.docx + video.mp4` - 文档+视频
- 邮件正文："活动报道内容..." + `photo1.jpg` - 正文+图片
- `report.docx + photo.jpg + video.mp4` - 文档+图片+视频

### 2. 外部链接类
**支持来源**：
- 微信公众号（mp.weixin.qq.com）
- 美篇（www.meipian.cn）
- 其他网站（需AI自动采集抓取）

**处理流程**：
1. 识别链接类型
2. 使用Playwright自动抓取网页内容
3. 提取标题、正文、图片
4. 下载图片到OSS
5. 生成草稿交由AI改写

**示例**：
```
# 公众号
https://mp.weixin.qq.com/s/K1xbW7b7xB2b51rgB28UzQ

# 美篇
https://www.meipian.cn/5jwb658d?share_depth=3

# 其他网站
https://example.com/news/article-123
```

### 3. 压缩包类
**支持格式**：.zip / .rar / .7z

**包内内容**：
- Word文档 + 图片
- Word文档 + 视频
- Word文档 + 图片 + 视频

**处理流程**：
1. 解压缩文件到临时目录
2. 扫描压缩包内文件
3. 提取Word文档内容
4. 收集图片文件
5. 收集视频文件
6. 上传图片到OSS
7. 上传视频到OSS（如有）
8. 生成草稿交由AI改写
9. 清理临时文件

**安全措施**：
- 防止Zip Slip攻击（路径穿越）
- 限制解压文件大小
- 限制解压文件数量
- 验证文件类型

**示例场景**：
- `package.zip` 包含：`report.docx + photo1.jpg + photo2.png`
- `package.zip` 包含：`report.docx + video.mp4`
- `package.zip` 包含：`report.docx + photo.jpg + video.mp4`

## 🔄 自动发布流程

### 标准媒体（荣、时、争、政）
1. 邮件解析 → 识别目标站点
2. 内容提取 → 抓取/提取内容
3. AI改写 → 第一人称转第三人称
4. 自动发布 → 发布到对应WordPress站点

### 今日头条（头）
1. 邮件解析 → 识别为头条内容
2. 内容提取 → 抓取/提取内容
3. AI改写 → 生成头条格式草稿
4. **手动发布** → 编辑审核后手动发布

## 📊 测试示例

### 示例1：公众号文章发布到时代网
```
邮件标题：投，时，凤翔区人社局，春风迎归人 人社暖民心
邮件正文：https://mp.weixin.qq.com/s/xxxxx
```
→ 自动抓取公众号内容 → AI改写 → 发布到站点B (时代网)

### 示例2：Word文档+图片发布到荣耀网
```
邮件标题：合，荣，汉台区图书馆，新年画艺术展
邮件附件：report.docx, photo1.jpg, photo2.png
```
→ 提取文档内容和图片 → 上传图片到OSS → AI改写 → 发布到站点A (荣耀网)

### 示例3：美篇文章发布到争先网
```
邮件标题：投，争，某单位，争先创优活动
邮件正文：https://www.meipian.cn/xxxxx
```
→ 自动抓取美篇内容 → AI改写 → 发布到站点C (争先网)

### 示例4：压缩包内容发布到政企网
```
邮件标题：合，政，某单位，重要活动报道
邮件附件：package.zip (包含 report.docx + photo1.jpg + video.mp4)
```
→ 解压缩 → 提取文档和媒体文件 → 上传到OSS → AI改写 → 发布到站点D (政企网)

### 示例5：邮件正文+图片发布到荣耀网
```
邮件标题：投，荣，某单位，活动简报
邮件正文：今天我们单位举办了...（直接写在邮件正文）
邮件附件：photo1.jpg, photo2.jpg
```
→ 提取正文内容和图片 → 上传图片到OSS → AI改写 → 发布到站点A (荣耀网)

### 示例6：今日头条草稿
```
邮件标题：投，头，重要单位，重大新闻
邮件正文：https://mp.weixin.qq.com/s/xxxxx
```
→ 自动抓取内容 → AI改写 → 生成草稿（不自动发布）

### 示例7：其他网站链接
```
邮件标题：合，时，某单位，新闻报道
邮件正文：https://example.com/news/article-123
```
→ AI自动采集抓取网页内容 → AI改写 → 发布到站点B (时代网)

## ⚙️ 技术实现

### 核心模块
- `app/services/email_parser.py` - 邮件解析服务（标题格式解析）
- `app/services/web_fetcher.py` - 网页抓取服务（公众号/美篇/其他网站）
- `app/tasks/email_tasks.py` - 邮件处理任务（统一处理入口）

### 内容提取
- **Word文档**：`python-docx` 提取文本和图片
- **邮件正文**：直接提取HTML/纯文本
- **压缩包**：`zipfile` 解压并扫描文件
- **外部链接**：`playwright` 自动化浏览器抓取

### 媒体处理
- **图片上传**：`oss2` 上传到阿里云OSS
- **视频上传**：`oss2` 上传到阿里云OSS
- **图片格式**：支持 jpg, jpeg, png, gif, bmp, webp
- **视频格式**：支持 mp4, avi, mov, wmv, flv, mkv

### 安全措施
- **Zip Slip防护**：验证解压路径，防止目录穿越
- **文件大小限制**：单个文件最大100MB
- **文件数量限制**：压缩包内最多100个文件
- **文件类型验证**：只允许白名单内的文件类型
- **SSRF防护**：外链抓取限制域名白名单

### 依赖库
```python
# 文档处理
python-docx==1.1.0

# 网页抓取
playwright==1.41.0
beautifulsoup4==4.12.3
lxml==5.1.0

# 存储
oss2==2.18.4

# 邮件处理
imap-tools==1.5.0
```

## 🚀 使用方法

### 手动触发邮件抓取
```bash
# 方法1：Docker命令
sudo docker-compose exec backend python -c "
from app.tasks.email_tasks import fetch_emails_task
result = fetch_emails_task()
print(result)
"

# 方法2：API调用（生产环境）
curl -X POST http://localhost:8000/api/monitoring/fetch-emails \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 查看处理结果
```bash
# 查看投稿记录
sudo docker-compose exec backend python -c "
import asyncio
from app.database import get_db
from sqlalchemy import text

async def check():
    async for db in get_db():
        result = await db.execute(text('SELECT id, email_subject, status FROM submissions ORDER BY id DESC LIMIT 5'))
        for row in result:
            print(f'ID:{row[0]} | {row[1]} | {row[2]}')
        break

asyncio.run(check())
"
```

## 📌 注意事项

1. **标题格式必须严格遵守**：`合作方式，媒体，单位，标题`
2. **公众号/美篇链接**：需要网络访问权限
3. **今日头条内容**：不会自动发布，需要人工审核
4. **图片处理**：自动下载并上传到OSS
5. **AI改写**：需要配置有效的AI API密钥

## 🔧 故障排查

### 邮件解析失败
- 检查标题格式是否正确
- 查看日志：`sudo docker-compose logs backend | grep "邮件解析"`

### 网页抓取失败
- 检查网络连接
- 验证URL是否有效
- 查看日志：`sudo docker-compose logs backend | grep "抓取"`

### 图片上传失败
- 检查OSS配置
- 验证OSS权限
- 查看日志：`sudo docker-compose logs backend | grep "上传"`
