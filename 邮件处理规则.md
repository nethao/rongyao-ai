# 邮件处理规则说明

## 📧 邮件标题格式

**格式**：`[合作方式]+[对应媒体]+[来稿单位名称]+[标题]`

**示例**：`投，时，凤翔区人社局，春风迎归人 人社暖民心`

### 合作方式
- `投` - 免费投稿客户
- `合` - 合作客户

### 媒体类型映射

| 标识 | 媒体名称 | WordPress站点 | 站点ID |
|------|----------|---------------|--------|
| 荣 | 荣耀网 | 站点A (a.com) | 7 |
| 时 | 时代网 | 站点B (b.com) | 8 |
| 争/优 | 争先网 | 站点C (c.com) | 9 |
| 政 | 政企网 | 站点D (d.com) | 10 |
| 头 | 今日头条 | 手动发布 | - |

## 📝 邮件内容类型

### 1. 公众号链接
**格式**：邮件正文包含微信公众号链接

**示例**：
```
https://mp.weixin.qq.com/s/K1xbW7b7xB2b51rgB28UzQ
```

**处理流程**：
1. 自动抓取公众号文章内容
2. 提取标题、正文、图片
3. 下载图片到OSS
4. 生成草稿交由AI改写

### 2. 美篇链接
**格式**：邮件正文包含美篇链接

**示例**：
```
https://www.meipian.cn/5jwb658d?share_depth=3
```

**处理流程**：
1. 自动抓取美篇文章内容
2. 提取标题、正文、图片
3. 下载图片到OSS
4. 生成草稿交由AI改写

### 3. Word文档
**格式**：邮件附件包含 .doc 或 .docx 文件

**处理流程**：
1. 提取文档文本内容
2. 提取文档中的图片
3. 上传图片到OSS
4. 生成草稿交由AI改写

### 4. 视频附件
**格式**：邮件附件包含视频文件 (.mp4, .avi, .mov等)

**处理流程**：
1. 识别为视频类型
2. 保存视频文件
3. 特殊处理（待实现）

## 🔄 自动发布流程

### 标准媒体（荣、时、争、政）
1. 邮件解析 → 识别目标站点
2. 内容提取 → 抓取/提取内容
3. AI改写 → 第一人称转第三人称
4. 自动发布 → 发布到对应WordPress站点

### 今日头条（头）
1. 邮件解析 → 识别为头条内容
2. 内容提取 → 抓取/提取内容
3. AI改写 → 生成头条格式草稿
4. **手动发布** → 编辑审核后手动发布

## 📊 测试示例

### 示例1：公众号文章发布到时代网
```
邮件标题：投，时，凤翔区人社局，春风迎归人 人社暖民心
邮件正文：https://mp.weixin.qq.com/s/xxxxx
```
→ 自动抓取公众号内容 → AI改写 → 发布到站点B (时代网)

### 示例2：Word文档发布到荣耀网
```
邮件标题：合，荣，汉台区图书馆，新年画艺术展
邮件附件：report.docx (含图片)
```
→ 提取文档内容和图片 → AI改写 → 发布到站点A (荣耀网)

### 示例3：美篇文章发布到争先网
```
邮件标题：投，争，某单位，争先创优活动
邮件正文：https://www.meipian.cn/xxxxx
```
→ 自动抓取美篇内容 → AI改写 → 发布到站点C (争先网)

### 示例4：今日头条草稿
```
邮件标题：投，头，重要单位，重大新闻
邮件正文：https://mp.weixin.qq.com/s/xxxxx
```
→ 自动抓取内容 → AI改写 → 生成草稿（不自动发布）

## ⚙️ 技术实现

### 新增模块
- `app/services/email_parser.py` - 邮件解析服务
- `app/services/web_fetcher.py` - 网页抓取服务

### 更新模块
- `app/tasks/email_tasks.py` - 邮件处理任务（支持新规则）

### 依赖库
- `requests` - HTTP请求
- `beautifulsoup4` - HTML解析
- `lxml` - XML/HTML解析器

## 🚀 使用方法

### 手动触发邮件抓取
```bash
# 方法1：Docker命令
sudo docker-compose exec backend python -c "
from app.tasks.email_tasks import fetch_emails_task
result = fetch_emails_task()
print(result)
"

# 方法2：API调用（生产环境）
curl -X POST http://localhost:8000/api/monitoring/fetch-emails \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 查看处理结果
```bash
# 查看投稿记录
sudo docker-compose exec backend python -c "
import asyncio
from app.database import get_db
from sqlalchemy import text

async def check():
    async for db in get_db():
        result = await db.execute(text('SELECT id, email_subject, status FROM submissions ORDER BY id DESC LIMIT 5'))
        for row in result:
            print(f'ID:{row[0]} | {row[1]} | {row[2]}')
        break

asyncio.run(check())
"
```

## 📌 注意事项

1. **标题格式必须严格遵守**：`合作方式，媒体，单位，标题`
2. **公众号/美篇链接**：需要网络访问权限
3. **今日头条内容**：不会自动发布，需要人工审核
4. **图片处理**：自动下载并上传到OSS
5. **AI改写**：需要配置有效的AI API密钥

## 🔧 故障排查

### 邮件解析失败
- 检查标题格式是否正确
- 查看日志：`sudo docker-compose logs backend | grep "邮件解析"`

### 网页抓取失败
- 检查网络连接
- 验证URL是否有效
- 查看日志：`sudo docker-compose logs backend | grep "抓取"`

### 图片上传失败
- 检查OSS配置
- 验证OSS权限
- 查看日志：`sudo docker-compose logs backend | grep "上传"`
