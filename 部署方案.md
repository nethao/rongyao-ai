## 荣耀AI审核发布系统 - 生产部署方案（详细版）

> 目标：在生产服务器上一次性部署成功，重启后配置与数据不丢失。

---

### 1. 架构与服务清单

- `backend`：FastAPI + Uvicorn
- `celery_worker`：异步任务（邮件抓取/清理/AI改写）
- `db`：PostgreSQL 15（有持久卷 `postgres_data`）
- `redis`：缓存/任务队列
- `frontend`：Vite 构建产物（Nginx容器）
- `nginx_proxy`：反向代理 + WP 静态目录映射
- `wp_a/wp_b/wp_c/wp_d` + `wp_db`：WordPress 站点（数据卷持久化）

---

### 2. 依赖与环境检查（部署前必做）

#### 2.1 服务器系统与基础软件
```bash
# 操作系统
cat /etc/os-release

# CPU / 内存 / 磁盘
lscpu | grep "CPU(s)"
free -h
df -h

# Docker 与 Compose
docker --version
docker-compose --version
```

最低建议：4C / 8G / 50G；推荐：8C / 16G / 100G。

#### 2.2 端口与防火墙
```bash
ss -lntp | egrep ':80|:443|:8000|:3000|:5432|:6379|:3306'
```
生产建议仅对外开放：`80/443`，`8000/3000` 仅内网或不对外。

#### 2.3 关键系统依赖（已写入镜像）
后端镜像内置：
- `libreoffice` / `libreoffice-writer`（Word解析）
- `p7zip-full` / `unrar-free`（RAR/7Z）
- `chromium`（Playwright/抓取）

#### 2.4 Python依赖（requirements）
关键包：
- `fastapi / uvicorn / sqlalchemy / asyncpg`
- `celery / redis`
- `python-docx / mammoth`
- `oss2`
- `crawl4ai / playwright`
- `html2text`

#### 2.5 前端构建依赖
- Node 20（容器内）
- Vite 5

---

### 3. 生产配置文件准备

#### 3.1 代码存放路径（推荐）
```bash
/opt/rongyao-ai
```

#### 3.2 .env 必填项（生产）
```env
POSTGRES_PASSWORD=强密码
POSTGRES_DB=glory_audit
POSTGRES_USER=postgres

REDIS_PASSWORD=强密码

JWT_SECRET_KEY=随机64字符
ENCRYPTION_KEY=随机32字符

OPENAI_API_KEY=xxxx
OPENAI_MODEL=xxxx
OPENAI_BASE_URL=xxxx

OSS_ACCESS_KEY_ID=xxxx
OSS_ACCESS_KEY_SECRET=xxxx
OSS_ENDPOINT=oss-cn-xxxx.aliyuncs.com
OSS_BUCKET_NAME=xxxx

IMAP_HOST=xxxx
IMAP_PORT=993
IMAP_USER=xxxx
IMAP_PASSWORD=xxxx
IMAP_USE_SSL=true

IMAGE_COMPRESS_DAYS=365
DATA_DELETE_DAYS=730
ATTACHMENT_RETENTION_DAYS=15

WP_DB_USER=wordpress
WP_DB_PASSWORD=强密码
WP_MYSQL_ROOT_PASSWORD=强密码
```

---

### 4. 生产部署步骤（标准流程）

#### 4.1 上传或克隆代码
```bash
cd /opt
git clone <repo> rongyao-ai
cd /opt/rongyao-ai
```

#### 4.2 配置环境变量
```bash
cp .env.example .env
vim .env
```

#### 4.3 构建镜像
```bash
docker-compose build
```

#### 4.4 启动服务
```bash
docker-compose up -d
docker-compose ps
```

#### 4.5 数据库初始化
```bash
docker-compose exec backend alembic upgrade head
```

如果已做过自定义 SQL（例如附件表、重复稿件表），执行：
```bash
docker exec -i rongyao-ai_db_1 psql -U postgres -d glory_audit < /opt/rongyao-ai/backend/migrations/create_submission_attachments.sql
docker exec -i rongyao-ai_db_1 psql -U postgres -d glory_audit < /opt/rongyao-ai/backend/migrations/create_duplicate_logs.sql
```

---

### 5. 验证与回归（部署后）

1. 登录页：验证码是否显示且可刷新。
2. 审核页：AI改写/Word上传/图片上传是否可用。
3. 外链图片/粘贴图片是否自动上传 OSS。
4. 发布流程：目标站点映射是否生效。
5. 附件保留：压缩包 15天、图片/视频长期保留。

---

### 6. 防止“重启后配置丢失”的措施（重点）

#### 6.1 容器自启动
`docker-compose.yml` 已加入 `restart: unless-stopped`：
- `db` / `redis` / `backend` / `frontend`
- 其他服务已有 `restart`（wp 与 celery）

#### 6.2 Docker 服务开机自启
```bash
systemctl enable docker
systemctl start docker
```

#### 6.3 Compose 开机自启
建议创建 systemd 服务：
`/etc/systemd/system/rongyao-ai.service`
```ini
[Unit]
Description=Rongyao AI Audit Stack
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
WorkingDirectory=/opt/rongyao-ai
ExecStart=/usr/local/bin/docker-compose up -d
ExecStop=/usr/local/bin/docker-compose down
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```
启用：
```bash
systemctl daemon-reload
systemctl enable rongyao-ai
systemctl start rongyao-ai
```

#### 6.4 数据与配置持久化
以下必须在宿主机持久化（不要放在容器内）：
- `.env`
- `docker-compose.yml`
- `nginx.conf`
- 业务代码（`/opt/rongyao-ai`）

数据库与 WordPress 已使用 Docker **命名卷**：
- `postgres_data`
- `wp_a_data` / `wp_b_data` / `wp_c_data` / `wp_d_data`
- `wp_db_data`

切记不要执行：
```bash
docker-compose down -v
```
这会删除所有数据库和WP数据。

---

### 7. 备份策略（生产必须）

#### 7.1 数据库备份
```bash
docker-compose exec db pg_dump -U postgres glory_audit > /opt/backup/glory_audit_$(date +%F).sql
```

#### 7.2 WordPress 数据库备份
```bash
docker-compose exec wp_db mysqldump -u root -p wp_a > /opt/backup/wp_a_$(date +%F).sql
```

#### 7.3 配置与代码备份
```bash
tar -czf /opt/backup/rongyao-ai-config_$(date +%F).tar.gz \
  /opt/rongyao-ai/.env /opt/rongyao-ai/docker-compose.yml /opt/rongyao-ai/nginx.conf
```

---

### 8. 常用运维命令

```bash
# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f backend
docker-compose logs -f celery_worker

# 重启单个服务
docker-compose restart backend

# 重启全部
docker-compose restart
```

#### 8.1 前端代码/排版修改后不显示怎么办

前端在 Docker 中是**构建时**把源码打成静态资源，容器内没有挂载源码目录。因此修改了 Vue 页面（如投稿列表 `SubmissionsView.vue`）后，**必须重新构建前端镜像并重启**才能看到效果：

```bash
# 在项目根目录执行
docker-compose build frontend
docker-compose up -d frontend
```

仅执行 `docker-compose restart frontend` 不会生效，因为镜像里仍是旧代码。  
本地开发时若用 `npm run dev` 跑前端（不经过 Docker），则保存后热更新即可，无需上述步骤。

---

### 9. 进一步生产预检需要的信息

我可以帮你做一次完整生产预检，需提供：
1. 生产服务器系统版本、内存、磁盘
2. 计划域名与SSL方案
3. 真实 `.env` 内容（敏感字段可脱敏）
4. 生产服务器上 Docker / Compose 版本
