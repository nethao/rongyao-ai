# 荣耀AI审核发布系统 - 日报 2026-02-15

## 工作时间
2026-02-15 02:00 - 05:05 (约3小时)

## 完成功能

### 1. 美篇文章图文混排保留 ✅
**问题**: 美篇文章抓取后图片全部堆积在文末，丢失原始排版

**解决方案**:
- 使用`mp-article-tpl`容器保留完整HTML结构
- 从HTML中按顺序提取图片和文本
- 上传图片到OSS后，替换HTML中的图片URL
- 草稿直接使用原始HTML（不经过AI转换）

**关键代码**:
```python
# backend/app/services/web_fetcher.py
async def fetch_meipian_article_async(self, url: str):
    content_tag = soup.find('div', {'class': 'mp-article-tpl'})
    # 返回: (title, text, images, original_html)
    
# backend/app/tasks/email_tasks.py
# 美篇和公众号使用HTML格式创建草稿
if (content_type == ContentType.WEIXIN or content_type == ContentType.MEIPIAN) and original_html:
    draft_content = original_html
```

**测试结果**: 
- 投稿47: 2张图片保留在原始位置（行3和行47）
- HTML长度6004字符，完整保留样式

### 2. 公众号/美篇文章直接展示原始HTML ✅
**需求**: 公众号和美篇文章保留原始样式，不进行AI转换

**实现**:
- 后端: 草稿直接使用`original_html`字段
- 前端: 检测`content_source`，显示黄色警告提示
- 提示文案: "此为公众号/美篇文章，需手动修改"

**关键代码**:
```vue
<!-- frontend/src/views/AuditView.vue -->
<el-alert
  v-if="contentSource === 'weixin' || contentSource === 'meipian'"
  :title="contentSource === 'weixin' ? '此为公众号文章，需手动修改' : '此为美篇文章，需手动修改'"
  type="warning"
  :closable="false"
  show-icon
>
  {{ contentSource === 'weixin' ? '公众号' : '美篇' }}文章已保留原始样式，请在编辑器中手动调整格式和内容。
</el-alert>
```

**测试结果**:
- 投稿45 (公众号): 69,322字符HTML，42张图片，完整保留`rich_media_content`
- 投稿46 (美篇): 6,004字符HTML，2张图片，完整保留`mp-article-tpl`

### 3. AI转换格式优化 ✅
**需求**: AI转换后的内容适配WordPress排版

**实现**:
- Prompt增强: 明确要求保留标题层级、添加首行缩进、图片不包裹标签
- 后处理: 自动识别中文标题（一、二、三、），添加h2/h3标签
- 图片处理: 移除`<p>`标签包裹，保持单独成行
- 段落格式: 自动添加`<p style="text-indent: 2em;">`

**关键代码**:
```python
# backend/app/services/draft_service.py
def format_content_for_wordpress(self, content: str) -> str:
    # 中文标题识别
    h2_pattern = re.compile(r'^[一二三四五六七八九十]+、.+')
    h3_pattern = re.compile(r'^（[一二三四五六七八九十]+）.+')
    
    # 图片不包裹p标签
    content = re.sub(r'<p[^>]*>\s*(!\[图片\d+\][^\n]+)\s*</p>', r'\1', content)
```

**测试结果** (投稿42):
- 1个h2标题 + 6个h3标题（自动识别）
- 9个段落带首行缩进
- 2张图片保留原始位置（行0和行16）
- 0个空行（清理完成）

### 4. 标题提取优化 ✅
**需求**: 使用文章标题而非邮件主题

**实现**:
- 优先使用抓取的文章标题（`fetched_title`）
- 前端显示: 原始内容区只读展示，AI内容区可编辑

**关键代码**:
```python
# backend/app/tasks/email_tasks.py
if fetched_title:
    title = fetched_title  # 优先使用抓取的标题
```

### 5. 模型切换 ✅
**修改**: 将AI模型从`gpt-4`切换为`qwen-plus`

**原因**: qwen-plus对中文格式化指令遵循更好

```bash
# .env
OPENAI_MODEL=qwen-plus
```

### 6. TinyMCE编辑器尝试（已回滚）
**尝试**: 替换Tiptap为TinyMCE全功能编辑器
- 创建TinyMCEEditor.vue组件
- 加载CDN和中文语言包
- 测试铺满容器和本地化

**结果**: 最终回滚到Tiptap编辑器（用户决策）

## 技术细节

### 内容处理流程
```
邮件 → 解析 → 检测类型
  ↓
公众号/美篇: Playwright抓取
  ↓
提取: title, HTML, images
  ↓
上传图片到OSS
  ↓
替换HTML中的图片URL
  ↓
创建草稿（使用原始HTML，跳过AI转换）
  ↓
前端显示警告提示 + 原始HTML
```

### 关键文件修改
1. `backend/app/services/web_fetcher.py` - 美篇抓取返回HTML
2. `backend/app/tasks/email_tasks.py` - 公众号/美篇使用HTML创建草稿
3. `backend/app/services/draft_service.py` - WordPress格式化
4. `backend/app/services/prompt_builder.py` - AI转换Prompt优化
5. `backend/app/api/drafts.py` - 返回content_source字段
6. `frontend/src/views/AuditView.vue` - 警告提示 + 标题显示

### 数据库状态
```sql
-- 最新投稿
45 | 【汉图展览】2026"新生活·新风尚·新年画"艺术展 | weixin  | 42 images | 69,322 chars
46 | 亲人的爱要见行动 | meipian | 2 images | 6,004 chars
47 | 亲人的爱要见行动 | meipian | 2 images | 6,004 chars (测试)
```

## 测试命令

### 测试公众号文章
```bash
sudo docker-compose exec backend python /app/mock_email.py \
  --sender "测试 <test@example.com>" \
  --subject "合，头，测试单位，测试公众号HTML草稿" \
  --url "https://mp.weixin.qq.com/s/K1xbW7b7xB2b51rgB28UzQ"
```

### 测试美篇文章
```bash
sudo docker-compose exec backend python /app/mock_email.py \
  --sender "测试 <test@example.com>" \
  --subject "合，头，测试单位，测试美篇HTML草稿" \
  --url "https://www.meipian.cn/5jzpry6s"
```

### 检查草稿内容
```bash
sudo docker-compose exec backend python -c "
import asyncio
from app.database import get_db
from sqlalchemy import text

async def check():
    async for db in get_db():
        result = await db.execute(text('SELECT id, current_content FROM drafts ORDER BY id DESC LIMIT 1'))
        row = result.fetchone()
        did, content = row
        print(f'草稿ID: {did}')
        print(f'内容长度: {len(content)}')
        print(f'是否HTML: {\"<div\" in content or \"<p\" in content}')
        print(f'图片数: {content.count(\"<img\")}')
        break
asyncio.run(check())
"
```

## 遗留问题

### 已知限制
1. AI转换可能仍会移动图片位置（模型限制，已通过后处理缓解）
2. 空行清理依赖正则表达式（可能有边界情况）
3. 中文标题识别仅支持"一、二、三、"和"（一）（二）"格式

### 待优化
1. 为公众号/美篇添加"重新AI转换"按钮（可选功能）
2. 改进图片位置保留算法
3. 添加版本对比可视化diff
4. 实现真实的Celery进度跟踪

## 成功标准 ✅

- ✅ 公众号文章保留原始样式（69K+ HTML）
- ✅ 美篇文章保留原始样式（6K+ HTML）
- ✅ 图文混排位置正确（图片在原始位置）
- ✅ 警告提示正常显示（黄色alert）
- ✅ 标题正确提取（文章标题，非邮件主题）
- ✅ AI转换格式正确（h2/h3标题 + 首行缩进）
- ✅ qwen-plus模型正常工作

## 下一步计划

### 优先级1: 端到端测试
- 测试完整发布流程: 提交 → 审核 → 编辑 → 发布到WordPress
- 验证公众号/美篇文章在WordPress中的显示效果

### 优先级2: 功能增强
- 添加手动触发AI转换按钮（针对公众号/美篇）
- 优化图片上传进度显示
- 添加草稿版本对比功能

### 优先级3: 性能优化
- 优化Playwright启动速度
- 实现图片批量上传
- 添加OSS上传失败重试机制

## 工作总结

今日主要解决了美篇和公众号文章的排版保留问题，核心思路是**跳过AI转换，直接使用原始HTML**。通过在前端添加警告提示，引导用户手动编辑，既保留了原始样式，又保持了系统的灵活性。

AI转换部分也进行了优化，通过Prompt增强和后处理，实现了自动格式化（标题识别、首行缩进、图片处理），提升了非HTML内容的转换质量。

系统目前已具备完整的内容处理能力，支持公众号、美篇、Word、纯文本等多种来源，下一步需要进行端到端测试，验证发布到WordPress的效果。
