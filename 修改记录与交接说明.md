# 修改记录与交接说明（交给 Kiro 接管）

**文档日期**：2026-02-26  
**用途**：近期修改汇总 + 接手人（Kiro）快速上手指南。

---

## 一、近期修改记录（按模块）

### 1. 安全与配置

| 项目 | 说明 | 涉及文件/配置 |
|------|------|----------------|
| JWT/加密 | 独立 `ENCRYPTION_KEY`，与 JWT 分离；解密失败抛异常 | `backend/app/config.py`, `backend/app/utils/encryption.py` |
| 配置必填 | `JWT_SECRET_KEY`、`DATABASE_URL`、`ENCRYPTION_KEY` 无弱默认值，启动校验 | `backend/app/config.py` |
| CORS | 使用 `ALLOWED_ORIGINS` 白名单，不再 `*` | `backend/app/main.py`, `.env` |
| 全局异常 | 生产环境不向客户端暴露内部错误详情 | `backend/app/main.py` |
| Zip Slip | 解压 ZIP 时校验路径，防止目录穿越 | `backend/app/tasks/email_tasks.py` |
| 管理员密码 | `init_admin.py` 必须通过环境变量 `ADMIN_PASSWORD` 设置（≥8 位） | `backend/scripts/init_admin.py` |
| IDOR/上传 | 删除投稿需管理员；Word 上传仅允许 `.doc`/`.docx` | `backend/app/api/submissions.py` |
| 分析接口 | 统计类接口仅管理员可访问 | `backend/app/api/analytics.py` |
| SSRF | 外链抓取限制 host 白名单（微信/美篇） | `backend/app/services/web_fetcher.py` |
| Docker | 后端以非 root 用户运行；前端生产用 Nginx 静态 | `docker/backend/Dockerfile`, `docker/frontend/Dockerfile` |

### 2. 大模型：仅保留阿里云百炼

| 项目 | 说明 | 涉及文件 |
|------|------|----------|
| 前端 | 删除 MiniMax / OpenRouter / OpenAI 预设与模型选项；只保留百炼 + 通义千问模型；API 端点固定为百炼 | `frontend/src/views/ConfigView.vue` |
| 后端默认 | 默认 `OPENAI_BASE_URL`、`OPENAI_MODEL=qwen-plus` | `backend/app/config.py` |
| LLM 服务 | 默认 base_url 用百炼；错误信息统一为「百炼」 | `backend/app/services/llm_service.py` |
| 环境变量 | `.env` 中 OPENAI 相关改为百炼说明与默认值 | 根目录 `.env`, `backend/.env` |

### 3. WordPress 发布

| 项目 | 说明 | 涉及文件/操作 |
|------|------|----------------|
| 发布历史表 | 原先缺少 `publish_history` 导致发布/查询失败 | 已在 PostgreSQL 中执行建表 SQL（见下） |
| 建表 SQL | 若新环境需执行一次 | 见本文「四、数据库」 |

### 4. 开发/运行环境

| 项目 | 说明 |
|------|------|
| 代码挂载 | `docker-compose.yml` 中 `backend`、`celery_worker` 挂载 `./backend:/app`，改代码无需重建镜像 |
| 前端 | 无挂载，改前端需 `docker-compose build frontend` 后重启 frontend |

### 5. 其他

| 项目 | 说明 |
|------|------|
| 手动发稿 | 投稿列表页「手动发稿」按钮因布局被挤掉，已调整布局保证始终可见 | `frontend/src/views/SubmissionsView.vue` |
| 批量测试 WP | 配置页增加「批量测试连接」调用 `POST /api/wordpress-sites/test-all` | `frontend/src/views/ConfigView.vue`, `backend/app/api/wordpress_sites.py` |

---

## 二、关键文件与入口（Kiro 快速定位）

- **后端入口**：`backend/app/main.py`
- **配置**：`backend/app/config.py`，环境变量来自根目录 `.env`（docker-compose 用）
- **任务队列**：`backend/app/tasks/`（Celery），AI 改写、发布等异步任务
- **前端配置页**：`frontend/src/views/ConfigView.vue`（AI/OSS/邮箱/WordPress）
- **投稿与草稿**：`frontend/src/views/SubmissionsView.vue`、`AuditView.vue`
- **部署与排错**：`部署准备清单.md`（数据库、WP、域名等）
- **历史操作**：`OPERATION_LOG.md`（更早的详细日志）

---

## 三、给 Kiro 的接管注意事项

1. **本地开发**  
   - 后端/Celery 已挂载 `./backend`，改完 Python 重启对应容器即可。  
   - 前端改完需：`docker-compose build frontend`，再重启 frontend 容器。

2. **环境变量**  
   - 根目录 `.env` 为 Docker 主配置（数据库、Redis、JWT、ENCRYPTION_KEY、ALLOWED_ORIGINS、百炼 KEY 等）。  
   - 敏感项不要提交到 Git；可保留 `.env.example` 做模板。

3. **AI 改写 401**  
   - 若出现「invalid API key」：先确认「系统配置」里百炼 API Key 正确；再确认 Celery Worker 与 Backend 使用同一套代码（挂载后一致）且 `ENCRYPTION_KEY` 一致，否则 Worker 解密配置会失败。

4. **发布到 WordPress 失败**  
   - 若报 `relation "publish_history" does not exist`：在 PostgreSQL 执行下面「四、数据库」中的建表 SQL。  
   - 其他发布失败：看 `backend` 或 `celery_worker` 日志；检查 WP 站点配置（应用密码、URL）及「批量测试连接」。

5. **Docker Compose 报错**  
   - 若出现 `KeyError: 'ContainerConfig'`，多为 docker-compose 与 Docker 版本兼容问题。可尝试：停止并删除相关容器后，再 `docker-compose up -d` 重新创建。

---

## 四、数据库（PostgreSQL）— 需确保存在的表

若在新环境部署或缺少 `publish_history`，在 `glory_audit` 库中执行：

```sql
CREATE TABLE IF NOT EXISTS publish_history (
    id SERIAL PRIMARY KEY,
    draft_id INTEGER NOT NULL REFERENCES drafts(id) ON DELETE CASCADE,
    site_id INTEGER NOT NULL REFERENCES wordpress_sites(id) ON DELETE CASCADE,
    wordpress_post_id INTEGER,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    message TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_publish_history_draft_id ON publish_history(draft_id);
CREATE INDEX IF NOT EXISTS idx_publish_history_site_id ON publish_history(site_id);
```

执行方式示例（按你实际容器名调整）：

```bash
docker-compose exec db psql -U postgres -d glory_audit -c "上述SQL"
```

---

## 五、交接清单（Kiro 可自检）

- [ ] 能成功 `docker-compose up -d` 并访问 e.com（或本地 3000 端口）
- [ ] 使用管理员账号登录、进入「系统配置」
- [ ] 确认 AI 配置为阿里云百炼，保存并「验证配置」通过
- [ ] 投稿列表「手动发稿」按钮可见且可用
- [ ] 任选一草稿「发布到 WordPress」不报错（且 `publish_history` 表已存在）
- [ ] 已阅读 `部署准备清单.md`，了解数据库与 WP 故障时的处理方式

---

以上为近期修改记录与交给 Kiro 接管的说明。后续若有新变更，建议在本文档或 `OPERATION_LOG.md` 中追加记录。
